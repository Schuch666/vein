---
title: "VEIN model"
author: "Sergio Ibarra-Espinosa"
date: "22 de abril de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

[![Travis-CI Build Status](https://travis-ci.org/atmoschem/vein.svg?branch=master)](https://travis-ci.org/atmoschem/vein)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/ibarraespinosa/vein?branch=master&svg=true)](https://ci.appveyor.com/project/ibarraespinosa/vein)
[![](http://cranlogs.r-pkg.org/badges/vein)](http://cran.rstudio.com/web/packages/vein/index.html)
[![Rdoc](http://www.rdocumentation.org/badges/version/vein)](http://www.rdocumentation.org/packages/vein)
[![DOI](https://zenodo.org/badge/88201850.svg)](https://zenodo.org/badge/latestdoi/88201850)
[![Coverage Status](https://img.shields.io/codecov/c/github/atmoschem/vein/master.svg)](https://codecov.io/github/atmoschem/vein?branch=master)
[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/vein)](http://cran.r-project.org/web/packages/vein) 
[![CRAN Downloads](http://cranlogs.r-pkg.org/badges/grand-total/vein?color=orange)](http://cran.r-project.org/package=vein)



![](https://raw.githubusercontent.com/atmoschem/vein/master/logovein_small.png)



## Vein Package

**V**ehicular **E**missions **IN**ventory **(VEIN)** model.

_Please read the documentation_.

### System requirements

vein imports functions from spatial packages listed below. In order to
install these packages, firstly the user must install the requirements
mentioned [here](https://www.github.com/r-spatial/sf).

### Packages needed

After installing system dependencies, you need these packages:

- [sf](https://github.com/r-spatial/sf)
- [sp](https://github.com/edzer/sp/) 
- [lwgeom](https://github.com/r-spatial/lwgeom/) 
- [units](https://github.com/edzer/units/) 

In order to run the demo, this package is also needed:

- [ggplot2](https://github.com/tidyverse/ggplot2)


### Installation

VEIN can be installed via CRAN or github

```{r eval = F}
# 0.3.1
library(devtools) 
install_github("atmoschem/vein")
library(vein)
demo(VEIN)
```

or

```{r eval=F}
# 0.3.9
install.packages("vein")
library(vein)
```

## What is new on 0.3.0 ?

I decided to jump into a new 'minor' version because it brings lots of cool
improvements.

- vein imports **sf** functions.
- R packages -raster-, -rgdal- and -rgeos- not needed anymore.
- vein now imports **data-table**.
- Add class GriddedEmissionsArray.
- Fix #28, data.table imported in emis_grid. Now it is very fast!
- Fix #49: Documentation in inventory est.
- Fix #50: Fix repetition of x_DF.
- Fix #51: deparse text.
- Fix #52: separate objects in rm with ','
- Fix #55.
- Minor fix on demo(VEIN).
- emis and emis_cold adjust length of ef by length of columns of first
element of the list of data-frames.
- Revised all examples.

Check the [NEWS](https://github.com/atmoschem/vein/blob/master/NEWS.md)


### How to use vein

VEIN consist of: "Elaboration of vehicular emissions inventories,
    consisting in four stages,
1) pre-processing activity data,
2) preparing emissions factors,
3) estimating the emissions and
4) post-processing of emissions in maps and databases."


This implies the use of several functions in a coordinates ans structured way,
therefore it is added the new function **inventory** which creates a structured
set of directories and scripts to run VEIN. Please, open the file 'main.R' and
run each line to understand VEIN. **Remember, if you have doubts with any function,
just type '?' with the name of the function. For intance: `?inventory`.**

```{r eval = T}
library(vein)
inventory(name = file.path(tempdir(), "YourCity"), show.dir = T,
          show.scripts = T)
```

Please, read the examples in the documentation of each function and run the demo. 

#### 1) Examples with traffic data:

age functions 

```{r}
data("net")
PC_E25_1400 <- age_ldv(x = net$ldv, name = "PC_E25_1400")
plot(PC_E25_1400, xlab = "age of use")
```

temporal factors and netspeed
```{r}
data("net")
data("pc_profile")
pc_week <- temp_fact(net$ldv+net$hdv, pc_profile)
dfspeed <- netspeed(pc_week, net$ps, net$ffs, net$capacity, net$lkm)
class(dfspeed)
plot(dfspeed, xlab = "hours") 
```

#### 2) Emission Factors

```{r}
V <- 0:150
ef1 <- ef_ldv_speed(v = "PC",t = "4S", cc = "<=1400", f = "G", eu = "PRE",
p = "CO")
efs <- EmissionFactors(ef1(1:150))
plot(Speed(1:150), efs, xlab = "speed[km/h]", type = "b", pch = 16)
```

#### 3) Estimation of emissions

```{r}
euro <- c(rep("V", 5), rep("IV", 5), rep("III", 5), rep("II", 5),
          rep("I", 5), rep("PRE", 15))
lef <- lapply(1:40, function(i) {
ef_ldv_speed(v = "PC", t = "4S", cc = "<=1400", f = "G",
          eu = euro[i], p = "CO", show.equation = FALSE) })
E_CO <- emis(veh = PC_E25_1400, lkm = net$lkm, ef = lef, speed = dfspeed,
             profile = pc_profile)
plot(E_CO, xlab = "Hours", ylab = "[g/h]")
```

#### 4) Post Emissions

```{r}
E_CO_STREETS <- emis_post(arra = E_CO, pollutant = "CO", by = "streets_wide")
summary(E_CO_STREETS)
```

make grid. If you plan to run WRF, uses [eixport::wrf_grid](https://github.com/atmoschem/eixport)

```{r}
data(net)
net@data <- cbind(net@data, E_CO_STREETS)
net@data <- net@data[,- c(1:9)]
g <- make_grid(net, 1/102.47/2, 1/102.47/2) #500m in degrees
E_CO_g <- emis_grid(spobj = net, g = g, sr= 31983)
plot(E_CO_g["V9"], axes = T)
```


###  Issues

If you encounter any issues while using VEIN, please submit your issues to: https://github.com/atmoschem/vein/issues/

If you have any suggestions just let me know to sergio.ibarra@usp.br.

Thanks and enjoy VEIN!

### **future steps**

- Add more support to sf.
- Estimation of evaporative emissions with Copert Tier 3.
- More speciations.
- A book (hopefully released in 2018).

#### Note:
The paper of vein on GMDD under open review. If you use VEIN, please, cite it:

Ibarra-Espinosa, S., Ynoue, R., O'Sullivan, S., Pebesma, E.,
  Andrade, M. D. F., and Osses, M. (2017). VEIN v0.2.2: an R
  package for bottom-up Vehicular Emissions Inventories Geosci.
  Model Dev. Discus, https://doi.org/10.5194/gmd-2017-193, in
  review, 2017.

https://doi.org/10.5194/gmd-2017-193
